---
title: "Reporte COVID"
author: "Luis Barrios"
date: "12/1/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(writexl)
library(RODBC)
library(dplyr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(fpp2)
library(sf)
library(sp)

########################
# ANÁLISIS COVID MINSA #
########################

#--------------------- DATA COVID DEL MINSA ---------------------#
datacovid<-read.csv("C:\\Users\\LBarrios\\Downloads\\positivos_covid.csv", sep = ";")
# FORMATEANDO LA FECHA
datacovid$FECHA_RESULTADO<-as.Date.character(datacovid$FECHA_RESULTADO,format = "%Y%m%d")

```

## Histórico de casos covid en Lima
Como se puede observar estamos en la "tercera ola", aunque cabe destacar que en esta ocasión el número de contagiados ha sobrepasado largamente al pico de anteriores periodos. Esto debido a la nueva variante OMICRON entre otros posibles factores.
```{r covid graphs, fig.asp=0.6, message=FALSE, warning=FALSE, include=FALSE, out.width=, paged.print=TRUE}
# graficando toda la data covid para LIMA
g1<-datacovid %>%
  filter(DEPARTAMENTO=="LIMA") %>%
  group_by(FECHA_RESULTADO) %>% 
  summarise(n=n()) %>%
  ggplot(mapping = aes(x=FECHA_RESULTADO,y=n))+
  geom_line(color="red") +
  theme_minimal()+
  labs(x="",y="Número de casos",
       title = "Número de casos por día en el departamento de Lima",
       caption = "Fuente: MINSA - Elaboración propia")




```

```{r show_figure, echo=FALSE, out.width="80%"}
g1
```

## Tendencia reciente de casos covid
En el siguiente gráfico se puede observar la tendencia de los casos confirmados durante las últimas tres semanas, como se puede observar, aproximadamente desde el 26 de diciembre comienza a escalar el virus nuevamente.

```{r total , echo=FALSE, fig.asp=0.6, message=FALSE, warning=FALSE, paged.print=TRUE, out.width = "80%"}
# graficando data covid desde una fecha
data1<-datacovid %>%
  filter(DEPARTAMENTO=="LIMA" & FECHA_RESULTADO>"2021-12-22") %>% group_by(FECHA_RESULTADO) %>% 
  summarise(n=n()) 
#grafico
g2<-data1 %>% ggplot(mapping = aes(x=FECHA_RESULTADO,y=n))+
  geom_line(color="red")+
  theme_minimal()+
  labs(x="",y="Número de casos por día",
       title = "Número de casos en el departamento de Lima",
       caption = "Fuente: MINSA - Elaboración propia")
```

```{r asd, echo=FALSE, out.width = "80%"}
g2
```

## Mapa Covid Enero 2022
El siguiente mapa representa el numero de casos covid por departamento, un color más cercano al negro representa un mayor número de contagiados, y viceversa, colores cercanos al blanco significan contagios cercanos a cero, es notorio que la diferencia de casos de contagiados entre Lima y los demás departamentos es abismal, pero este puede ser un resultado sesgado dado que no se esta tomando en cuenta que Lima tambien posee una cantidad de habitantes sumamente superior a los demás.
```{r mapa1, fig.asp=0.6, message=FALSE, warning=FALSE, include=FALSE, out.width=, paged.print=TRUE}
# GENERANDO MAPA COVID POR DEPARTAMENTOS de todo el periodo
peru_d <- st_read("C:/Users/LBarrios/Downloads/MAPA/dp.shp")
data2<-datacovid %>% filter(FECHA_RESULTADO>"2021-12-31") %>% group_by(DEPARTAMENTO) %>% summarise(n=n())
names(data2)[1]="NOMBDEP"

peru_datos<-peru_d %>% 
  left_join(data2)

# MAPA contagios enero por departamento
g3<-ggplot(peru_datos) +
  geom_sf(aes(fill = n))+
  labs(title = "Número de contagiados por COVID Enero - 2022",
       caption = "Fuente: MINSA (2022)
       Elaboración propia"
  )+
  scale_fill_continuous(low="white",
                        high="black" ,
                        guide_legend(title = "Número de casos"))+
  theme(axis.ticks.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank())
```
```{r mapa2, echo=FALSE}
g3
```

## Mapa ratio Covid
Por lo tanto se incluye la variable poblacion por departamento en el análisis, siendo el ratio generado la división entre el número de casos confirmados y el número de personas que habitan dicho departamento, el ratio podría ser interpretado como el porcentaje de personas que estan infectadas en determinado departamento, siendo por lo tanto, un ratio mayor(color cercano a negro) un indicador de mayor porcentaje de contagiados, en consecuencia, los departamentos más cercanos al color negro estan en una pero situación sanitaria que aquellos con colores cercanos al blanco.
```{r mapa3, fig.asp=0.6, message=FALSE, warning=FALSE, include=FALSE, out.width=, paged.print=TRUE}
#-------------------------------#
# AGREGANDO POBLACIÓN A LA DATA #
#-------------------------------#
población<-as.data.frame( unique(data2$NOMBDEP))
names(población)<-"NOMBDEP"
población$personas<-c("426806","1180638","430736","1497438","668213","1453711","1129854","1357075","365317","760267","975182","1361467","2016771","1310785","10628470","1027559","173811","192740","271904","2047954","1237997","899648","370974","251521","589110")
población$personas<-as.numeric( población$personas)

peru_datos<-peru_datos %>% 
  left_join(población)
# ratio de numero de personas por departamento entre cuantas estan contagiadas
peru_datos<-peru_datos %>% mutate(ratio=n/personas*100)

#
g4<-ggplot(peru_datos) +
  geom_sf(aes(fill = ratio))+
  labs(title = "Contagiados por COVID Enero - 2022",
       caption = "Fuente: MINSA (2022)
       Elaboración propia", subtitle="Ratio = Casos confirmados entre población total"
       
  )+
  scale_fill_continuous(low="white",
                        high="black" ,
                        guide_legend(title = "Porcentaje infectados"))+
  theme(axis.ticks.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank())

```

```{r mapa4, echo=FALSE}
g4
```

